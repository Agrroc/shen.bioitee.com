<!DOCTYPE html>
<html lang="zh-cmn-Hans">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"> 
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"> 
    <link rel="stylesheet" href="../../../fonts/academicons-1.8.6/css/academicons.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
    <link rel="icon" type="image/png" sizes="32x32" href="../../../img/logo.png"> 
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    
    
    
    
    
    <title>Galaxy 生信平台（一）：安装 - Steven Shen | 沈维燕</title> 
    <meta property="og:title" content="Galaxy 生信平台（一）：安装 - Steven Shen | 沈维燕">
    

    
      
    

    

    
  
    <link rel="stylesheet" href="https://shen.bioitee.com/css/style.css"/>
    <link rel="stylesheet" href="https://shen.bioitee.com/css/fonts.css"/>
    

<link rel="stylesheet" href="https://shen.bioitee.com/css/custom.css" />

  </head>

  
  <body class="topic">
    
    
    <header class="intro-and-nav" role="banner">
    <div>
      <div class="intro">
        <a class="logo" href="../../../" aria-label="Steven Shen | 沈维燕 home page">
          <img src="https://shen.bioitee.com/img/logo.png" alt="">
        </a>
        <p class="library-desc">
          
            Welcome to the blog site of Steven Shen.
          
        </p>
      </div>
      <nav id="patterns-nav" class="patterns" role="navigation">
        <h2 class="vh">Main navigation</h2>
        <button id="menu-button" aria-expanded="false">
          
          Menu
        </button>
        
        <ul id="patterns-list">
          
          <li class="pattern">
          
          
          
            <a href="../../../" >
              
              首页
            </a>
          </li>
          
          <li class="pattern">
          
          
          
            <a href="../../../topic/tech/" >
              
              技术
            </a>
          </li>
          
          <li class="pattern">
          
          
          
            <a href="../../../topic/life/" >
              
              生活
            </a>
          </li>
          
          <li class="pattern">
          
          
          
            <a href="../../../topic/read/" >
              
              读书
            </a>
          </li>
          
          <li class="pattern">
          
          
          
            <a href="../../../topic/tags/" >
              
              标签
            </a>
          </li>
          
          <li class="pattern">
          
          
          
            <a href="../../../topic/archives/" >
              
              归档
            </a>
          </li>
          
          

<li class="pattern">&nbsp;&nbsp;</li>



<li class="pattern"><a href="https://github.com/shenweiyan/shen.bioitee.com/edit/master/content/topic/tech/2019-09-11-installation.md" target="_blank">编辑</a></li>


<li class="pattern"><a href="../../../topic/index.xml" type="application/rss+xml" title="RSS feed">订阅</a></li>

<li class="pattern"><a href="../../../declare/" title="声明">声明</a></li>


        </ul>
      </nav>
    </div>
    </header>

    <article class="main">
      <header class="title">
      
  



<h1>Galaxy 生信平台（一）：安装</h1>






<h3>沈维燕 &middot 
2019-09-11</h3> 


   
  



      </header>


  
  
  

  
  
  

  

<p>Galaxy Project（<a href="https://galaxyproject.org/">https://galaxyproject.org/</a>）是在云计算背景下诞生的一个生物信息学可视化分析开源项目。</p>

<p>该项目由美国国家科学基金会（NSF）、美国国家人类基因组研究所（NHGRI）、哈克生命科学研究所（The Huck Institutes of the Life Sciences）、宾州州立大学网络科学研究所（The Institute for CyberScience at Penn State），以及约翰霍普金斯大学（Johns Hopkins University）提供支持，是目前生物医学研究领域最受欢迎的在线生物信息分析工具之一。</p>

<blockquote>
<p>The Galaxy Project is supported in part by NSF, NHGRI, The Huck Institutes of the Life Sciences, The Institute for
CyberScience at Penn State, and Johns Hopkins University.</p>
</blockquote>

<p>从 2015 年起，Galaxy 源码从 bitbucket 转移至 GitHub 托管，截止 2019.09.11，Galaxy 在 GitHub 上一共有 636个 star，218 个贡献者，54 个发布的版本。</p>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1568171961186-4c938202-5149-4af6-9804-4468b1d55c0a.png#align=left&amp;display=inline&amp;height=305&amp;name=image.png&amp;originHeight=305&amp;originWidth=774&amp;size=44884&amp;status=done&amp;style=none&amp;width=774"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1568171961186-4c938202-5149-4af6-9804-4468b1d55c0a.png#align=left&amp;display=inline&amp;height=305&amp;name=image.png&amp;originHeight=305&amp;originWidth=774&amp;size=44884&amp;status=done&amp;style=none&amp;width=774" alt=""></a></p>

<p>从今天开始我们来介绍一下 Ggalaxy 生物信息分析平台从安装、部署，到开发的一些知识。</p>

<hr />

<h3 id="1-环境准备">1. 环境准备</h3>

<p>Galaxy 在 release_18.09 前的版本都是基于 Python 2.7.x 进行安装部署，虽然官方在 <a href="https://docs.galaxyproject.org/en/master/releases/18.09_announce.html">release_18.09</a> 中说明已经支持 python3（beta），但安装起来比较复杂，尤其与结合 conda 集合情况下的安装，并且不方便管理。</p>

<blockquote>
<p>After almost 3 years of work and more than 100 pull requests, we are proud to announce the Beta-stage support for running Galaxy under Python 3. Lint, unit, API, framework, integration and Selenium tests all pass, time for you to give it a try and report any bug you find!</p>

<p>From: <a href="https://docs.galaxyproject.org/en/master/releases/18.09_announce.html">https://docs.galaxyproject.org/en/master/releases/18.09_announce.html</a></p>
</blockquote>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1568169612966-492007f5-561f-4594-9982-c0cf58edbb91.png#align=left&amp;display=inline&amp;height=273&amp;name=image.png&amp;originHeight=273&amp;originWidth=766&amp;size=63379&amp;status=done&amp;style=none&amp;width=766"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1568169612966-492007f5-561f-4594-9982-c0cf58edbb91.png#align=left&amp;display=inline&amp;height=273&amp;name=image.png&amp;originHeight=273&amp;originWidth=766&amp;size=63379&amp;status=done&amp;style=none&amp;width=766" alt=""></a></p>

<p>从 release_19.05 起，Galaxy 对 Python 3 提供了比较好的支持（<strong>Galaxy is currently supported on Python 2.7 and &gt;=3.5</strong>），在本教程我们将以 release_19.09 最新版本的 Galaxy 为基础，进行一系列安装、部署和简单开发说明。</p>

<blockquote>
<p>Galaxy is currently supported on Python 2.7 and &gt;=3.5 . To run Galaxy, please install a supported Python version. If a supported version is already installed but is not your default, <a href="https://galaxyproject.org/admin/python/ contains">https://galaxyproject.org/admin/python/ contains</a> instructions on how to force Galaxy to use a different version.
From: <a href="https://github.com/galaxyproject/galaxy/blob/release_19.09/scripts/check_python.py">https://github.com/galaxyproject/galaxy/blob/release_19.09/scripts/check_python.py</a></p>
</blockquote>

<h4 id="1-1-conda-和-virtualenv">1.1 conda 和 virtualenv</h4>

<p>Galaxy 提供了 <code>conda</code> 和 <code>virtualenv</code> 环境下的 Galaxy 安装，它们之间的区别，具体可以参考：《<a href="https://docs.galaxyproject.org/en/master/admin/framework_dependencies.html#conda">Galaxy Admin Documentation: Framework Dependencies</a>》。喜欢 conda 的用户可以参考文档一步一步进行操作，这里不细述。我们重点介绍一下基于 virtualenv 环境的 Galaxy 安装。</p>

<h4 id="1-2-python">1.2 Python</h4>

<p>基于 virtualenv 环境安装 Galaxy，我们只需要安装好 <strong>Python&gt;=3.5</strong> 即可，因为 galaxy 在执行 run.sh 安装程序时会自动检测 virtualenv 是否安装，没有安装则会自动 pip 安装。</p>

<p>关于 Python-3 源码安装的具体方法，请参考：《<a href="https://www.yuque.com/shenweiyan/cookbook/install-python-from-source">Linux 下 Python 源码编译安装</a>》。</p>

<h3 id="2-源码与安装">2. 源码与安装</h3>

<h4 id="2-1-源码下载">2.1 源码下载</h4>

<p><strong>第一次安装。</strong>第一次安装 Galaxy 的用户可以通过下面的方法下载对应版本的代码库。</p>

<pre><code class="language-bash">$ git clone -b release_19.09 https://github.com/galaxyproject/galaxy.git
</code></pre>

<p><strong>已有代码库更新。</strong>已经安装了 Galaxy 的用户可以通过下面的方式更新。</p>

<pre><code class="language-bash">$ git fetch origin &amp;&amp; git checkout release_19.09 &amp;&amp; git pull --ff-only origin release_19.09
</code></pre>

<p><strong>开发版本。</strong>要获取 Galaxy 进行开发，请在克隆后使用默认分支： <code>dev</code> 。</p>

<pre><code class="language-bash">$ git clone https://github.com/galaxyproject/galaxy.git
</code></pre>

<h4 id="2-2-启动">2.2 启动</h4>

<p>有了源码后，下一步我们就可以启动 Galaxy。Galaxy 的启动需要运行一些东西：virtualenv，配置文件和依赖的 Python 模块。幸运的是，首次启动 Galaxy 服务器将根据需要创建并获取这些内容。要启动 Galaxy，只需在终端窗口中运行以下命令：</p>

<pre><code class="language-bash">$ sh run.sh
Initializing tool-data/shared/ucsc/builds.txt from builds.txt.sample
Initializing tool-data/shared/ucsc/manual_builds.txt from manual_builds.txt.sample
Initializing static/welcome.html from welcome.html.sample
Creating Python virtual environment for Galaxy: .venv
To avoid this, use the --no-create-venv flag or set $GALAXY_VIRTUAL_ENV to an
existing environment before starting Galaxy.
Fetching https://files.pythonhosted.org/packages/source/v/virtualenv/virtualenv-16.1.0.tar.gz
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:--  0:00:02 --:--:--     0
100 1930k  100 1930k    0     0  18308      0  0:01:47  0:01:47 --:--:-- 59849
Verifying /tmp/galaxy-virtualenv-1mvK4M/virtualenv-16.1.0.tar.gz checksum is f899fafcd92e1150f40c8215328be38ff24b519cd95357fa6e78e006c7638208
Using base prefix '/usr/local/software/python-3.7'
New python executable in /galaxy-dist/v-19.09/galaxy/.venv/bin/python
Installing setuptools, pip, wheel...
done.
Activating virtualenv at .venv
Looking in indexes: https://wheels.galaxyproject.org/simple, https://pypi.python.org/simple
Downloading https://files.pythonhosted.org/packages/4f/b5/3ea9ae3d1096b9ff31e8f1846c47d49f3129a12464ac0a73b602de458298/adal-1.2.2-py2.py3-none-any.whl (53kB)
    100% |████████████████████████████████| 61kB 24kB/s
......
galaxy.web_stack INFO 2019-09-11 17:08:46,889 [p:11902,w:1,m:0] [MainThread] Galaxy server instance 'main.web.1' is running
Starting server in PID 11902.
serving on http://localhost:8080
galaxy.model.database_heartbeat DEBUG 2019-09-11 17:08:46,921 [p:11902,w:1,m:0] [database_heartbeart_main.web.1.thread] main.web.1 is config watcher
</code></pre>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2019/png/126032/1568293214413-3f04b1e2-415e-4f8d-b487-e94f70606f00.png#align=left&amp;display=inline&amp;height=1042&amp;name=home-page.png&amp;originHeight=1042&amp;originWidth=1920&amp;size=128944&amp;status=done&amp;style=none&amp;width=1920"><img src="https://note.bioitee.com/yuque/0/2019/png/126032/1568293214413-3f04b1e2-415e-4f8d-b487-e94f70606f00.png#align=left&amp;display=inline&amp;height=1042&amp;name=home-page.png&amp;originHeight=1042&amp;originWidth=1920&amp;size=128944&amp;status=done&amp;style=none&amp;width=1920" alt="home-page.png"></a></p>

<p><strong>注意与提示：</strong></p>

<ul>
<li>使用 Python 3 安装 Galaxy，需要保证 SSL 模块正常可用。</li>
<li>如果在第一次启动 Galaxy 过程中出现如下报错，参考后面的方法进行解决。</li>
</ul>

<pre><code class="language-bash">$ sh run.sh
......
During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File &quot;/galaxy-dist/v-19.09/galaxy/.venv/bin/nodeenv&quot;, line 11, in &lt;module&gt;
    sys.exit(main())
  File &quot;/galaxy-dist/v-19.09/galaxy/.venv/lib/python3.7/site-packages/nodeenv.py&quot;, line 1076, in main
    create_environment(env_dir, opt)
......
File &quot;/usr/local/software/python-3.7/lib/python3.7/urllib/request.py&quot;, line 1319, in do_open
    raise URLError(err)
urllib.error.URLError: &lt;urlopen error [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056)&gt;

$ vi /galaxy-dist/v-19.09/galaxy/.venv/lib/python3.7/site-packages/nodeenv.py
...
import glob

##SSL CERTIFICATE_VERIFY_FAILED, add by shenweiyan, 2019.09
import ssl
ssl._create_default_https_context = ssl._create_unverified_context
....
</code></pre>

<ul>
<li>使用 <code>sh run.sh</code> ，第一次启动时，Galaxy 会默认检查 nodeenv、node、yarn 是否已经安装，如果没有将会自动执行 latest 版本安装。详情可以参考：

<ul>
<li><code>$GALAXY_ROOT/requirements.txt</code> </li>
<li><code>$GALAXY_ROOT/scripts/common_startup.sh</code> </li>
</ul></li>
<li>nodeenv、node、yarn 安装完成后，Galaxy 接着会自动安装 NodeJS 依赖：</li>
</ul>

<pre><code class="language-bash">cd client &amp;&amp; yarn install --network-timeout 300000 --check-files
</code></pre>

<p> </p>

<ul>
<li>nodeenv、node、yarn，以及 NodeJS 依赖的安装非常耗时间，尤其在网络不好时经常会出现各种报错，如果想要跳过这些安装，可以在初始化启动时增加一个 <code>--skip-client-build</code> 参数。 </li>
</ul>

<pre><code class="language-bash">$ sh run.sh --skip-client-build
</code></pre>

<ul>
<li>上面的东西安装完成后，Galaxy 接着会执行一个 conda 安装，安装目录默认位于 <code>galaxy/database/dependencies/_conda</code> ，这是为方便以后管理员可以通过 Galaxy web 的管理员页面自动安装 Galaxy shed tools 工具。</li>
</ul>

<h3 id="3-基本配置">3. 基本配置</h3>

<h4 id="3-1-配置文件">3.1 配置文件</h4>

<p>从 releases_18.01 起，Galaxy 可以在没有显式配置文件的情况下正常运行，但如果要修改其设置，则需要创建一个配置文件。推荐的做法是，复制模板配置文件并将其重命名为 <code>galaxy.yml</code> 。我们可以使用此命令执行此操作：</p>

<pre><code class="language-bash">$ cp config/galaxy.yml.sample config/galaxy.yml
</code></pre>

<h4 id="3-2-网络">3.2 网络</h4>

<p>Galaxy 默认通过本机 localhost 进行访问，要通过网络访问 Galaxy，需要在 <code>config/galaxy.yml</code> 文件中更改 http 设置。通过更改它，Galaxy 将绑定到任何可用的网络接口而不是 localhost：</p>

<pre><code class="language-bash"># Use ':8080' to listen on all available network interfaces.
http: :8080
</code></pre>

<h4 id="3-3-管理员">3.3 管理员</h4>

<p>要通过 UI 控制 Galaxy（安装工具，管理用户，创建组等），用户必须成为管理员。只有注册用户才能成为管理员。 要授予用户管理员权限，请将用户的 Galaxy 登录电子邮件添加到配置文件 <code>config/galaxy.yml</code> 中。配置示例如下所示：</p>

<pre><code class="language-bash"># this should be a comma-separated list of valid Galaxy users
admin_users: ishenweiyan@qq.com,user2@example.com
</code></pre>

<p>到这里，Galaxy 的本地化安装就全部完成了。下一章节，我们将介绍一下如何在生产环境中部署一个满足多用户使用的 Galaxy 在线分析平台。</p>

<p><a data-fancybox="gallery" href="https://note.bioitee.com/yuque/0/2020/gif/126032/1582856852147-6ed11b57-4ae6-4501-8835-ba6f34a07f29.gif#align=left&amp;display=inline&amp;height=157&amp;name=comment.gif&amp;originHeight=157&amp;originWidth=164&amp;size=29605&amp;status=done&amp;style=none&amp;width=164"><img src="https://note.bioitee.com/yuque/0/2020/gif/126032/1582856852147-6ed11b57-4ae6-4501-8835-ba6f34a07f29.gif#align=left&amp;display=inline&amp;height=157&amp;name=comment.gif&amp;originHeight=157&amp;originWidth=164&amp;size=29605&amp;status=done&amp;style=none&amp;width=164" alt="comment.gif"></a></p>


  <footer>
  
<nav class="post-nav">
  <span class="nav-prev">
      
      <a href="../../../topic/tech/2019-08-23-css-rem/">前端移动端适配方案之 rem</a>
      <br/>&larr;&nbsp;
      
  </span>
  <span class="nav-next">
      
      <a href="../../../topic/tech/2019-09-12-github-fork-update/">如何同步更新 Github 上 Fork 的项目？</a>
      <br/>&nbsp;&rarr;
      
  </span>
</nav>
<script type="text/javascript">
document.addEventListener('keyup', function(e) {
  if (e.target.nodeName.toUpperCase() != 'BODY') return;
  var url = false;
  if (e.which == 37) {  
    
    url = '\/topic\/tech\/2019-08-23-css-rem\/';
    
  } else if (e.which == 39) {  
    
    url = '\/topic\/tech\/2019-09-12-github-fork-update\/';
    
  }
  if (url) window.location = url;
});
</script>



<section class="comments">
<script src="https://utteranc.es/client.js"
        repo="shenweiyan/issues"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</section>




<script async src="../../../js/fix-toc.js"></script>

<script async src="../../../js/center-img.js"></script>

<script async src="../../../js/right-quote.js"></script>

<script async src="../../../js/no-highlight.js"></script>

<script async src="../../../js/fix-footnote.js"></script>

<script async src="../../../js/math-code.js"></script>

<script async src="../../../js/external-link.js"></script>

<script async src="../../../js/alt-title.js"></script>

<script async src="../../../js/header-link.js"></script>

<script async src="../../../js/dom-scripts.js"></script>


<script async src="//cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>



  
  
  
  

  <script type="text/javascript" src="//rf.revolvermaps.com/0/0/6.js?i=5m6pzaeh5ar&amp;m=0&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=0&amp;bv=0" async="async"></script>
  </footer>
  </article>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
  </body>
</html>

