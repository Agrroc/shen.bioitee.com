<!DOCTYPE html>
<html lang="zh-cmn-Hans">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"> 
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"> 
    <link rel="stylesheet" href="../../../fonts/academicons-1.8.6/css/academicons.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
    <link rel="icon" type="image/png" sizes="32x32" href="../../../img/logo.png"> 
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    
    
    
    
    
    <title>Galaxy 生信平台（三）：xlsx 上传与识别 - Steven Shen | 沈维燕</title> 
    <meta property="og:title" content="Galaxy 生信平台（三）：xlsx 上传与识别 - Steven Shen | 沈维燕">
    

    
      
    

    

    
  
    <link rel="stylesheet" href="https://shen.bioitee.com/css/style.css"/>
    <link rel="stylesheet" href="https://shen.bioitee.com/css/fonts.css"/>
    

<link rel="stylesheet" href="https://shen.bioitee.com/css/custom.css" />

  </head>

  
  <body class="topic">
    
    
    <header class="intro-and-nav" role="banner">
    <div>
      <div class="intro">
        <a class="logo" href="../../../" aria-label="Steven Shen | 沈维燕 home page">
          <img src="https://shen.bioitee.com/img/logo.png" alt="">
        </a>
        <p class="library-desc">
          
            Welcome to the blog site of Steven Shen.
          
        </p>
      </div>
      <nav id="patterns-nav" class="patterns" role="navigation">
        <h2 class="vh">Main navigation</h2>
        <button id="menu-button" aria-expanded="false">
          
          Menu
        </button>
        
        <ul id="patterns-list">
          
          <li class="pattern">
          
          
          
            <a href="../../../" >
              
              首页
            </a>
          </li>
          
          <li class="pattern">
          
          
          
            <a href="../../../topic/tech/" >
              
              技术
            </a>
          </li>
          
          <li class="pattern">
          
          
          
            <a href="../../../topic/life/" >
              
              生活
            </a>
          </li>
          
          <li class="pattern">
          
          
          
            <a href="../../../topic/read/" >
              
              读书
            </a>
          </li>
          
          <li class="pattern">
          
          
          
            <a href="../../../topic/tags/" >
              
              标签
            </a>
          </li>
          
          <li class="pattern">
          
          
          
            <a href="../../../topic/archives/" >
              
              归档
            </a>
          </li>
          
          

<li class="pattern">&nbsp;&nbsp;</li>



<li class="pattern"><a href="https://github.com/shenweiyan/shen.bioitee.com/edit/master/content/topic/tech/2020-01-02-galaxy-xlsx-issues.md" target="_blank">编辑</a></li>


<li class="pattern"><a href="../../../topic/index.xml" type="application/rss+xml" title="RSS feed">订阅</a></li>

<li class="pattern"><a href="../../../declare/" title="声明">声明</a></li>


        </ul>
      </nav>
    </div>
    </header>

    <article class="main">
      <header class="title">
      
  



<h1>Galaxy 生信平台（三）：xlsx 上传与识别</h1>






<h3>
2020-01-02</h3> 


   
  



      </header>


  
  
  

  
  
  

  

<p>我在《<a href="https://www.yuque.com/shenweiyan/cookbook/firefox-quantum"><strong>Firefox Quantum 向左，Google Chrome 向右</strong></a><strong>》</strong>中，曾经吐槽过在 Firefox 中使用 Galaxy 上传本地的 Excel 文件时，会出现 xlsx 无法识别异常的问题。今天，我们来聊一聊原因。</p>

<h2 id="背景">背景</h2>

<p>关于 Galaxy 生物信息平台，这里就不多说了，感兴趣的可以参考本专栏的前两篇文章。对于数据上传，Galaxy 不仅可以支持 NCBI SRA、EBI SRA、UCSC main table browser 等数据库数据的无缝对接。</p>

<p><a data-fancybox="gallery" href="https://qiniu.bioinit.com/yuque/0/2020/png/126032/1577937325706-b6378e9f-be06-4da9-bbc1-30315efbe348.png#align=left&amp;display=inline&amp;height=508&amp;name=image.png&amp;originHeight=508&amp;originWidth=347&amp;size=23558&amp;status=done&amp;style=none&amp;width=347"><img src="https://qiniu.bioinit.com/yuque/0/2020/png/126032/1577937325706-b6378e9f-be06-4da9-bbc1-30315efbe348.png#align=left&amp;display=inline&amp;height=508&amp;name=image.png&amp;originHeight=508&amp;originWidth=347&amp;size=23558&amp;status=done&amp;style=none&amp;width=347" alt=""></a></p>

<p>在本地文件的上传中，Galaxy 支持包括 ab1、arff、fasta、fastq、xlsx 在内 100 多种常见的格式数据上传。</p>

<p><a data-fancybox="gallery" href="https://qiniu.bioinit.com/yuque/0/2020/png/126032/1577935879824-f6ede4fa-0d96-4e78-bcfb-43b62526c6fd.png#align=left&amp;display=inline&amp;height=432&amp;name=image.png&amp;originHeight=432&amp;originWidth=723&amp;size=34902&amp;status=done&amp;style=none&amp;width=723"><img src="https://qiniu.bioinit.com/yuque/0/2020/png/126032/1577935879824-f6ede4fa-0d96-4e78-bcfb-43b62526c6fd.png#align=left&amp;display=inline&amp;height=432&amp;name=image.png&amp;originHeight=432&amp;originWidth=723&amp;size=34902&amp;status=done&amp;style=none&amp;width=723" alt=""></a></p>

<p>对于不太熟悉命令行操作的科研工作者，Excel 是他们进行批量订单提交和处理最喜欢也是最熟悉的一个数据格式，因此，我们以 Galaxy 为基础开发一部分定制化工具中，有很大的一部分都是基于 excel 文件进行处理的工具。但随之而来的问题是，所有的这些工具在 Google Chrome 下可以运行良好，但是在 Firefox 下却出现了问题。</p>

<p><a data-fancybox="gallery" href="https://qiniu.bioinit.com/yuque/0/2019/png/126032/1561788526653-5fec525f-ec2e-4aa6-829f-5f0034bc5fc9.png#align=left&amp;display=inline&amp;height=335&amp;originHeight=335&amp;originWidth=288&amp;status=done&amp;style=none&amp;width=288"><img src="https://qiniu.bioinit.com/yuque/0/2019/png/126032/1561788526653-5fec525f-ec2e-4aa6-829f-5f0034bc5fc9.png#align=left&amp;display=inline&amp;height=335&amp;originHeight=335&amp;originWidth=288&amp;status=done&amp;style=none&amp;width=288" alt=""></a></p>

<h2 id="xlsx-文件上传">xlsx 文件上传</h2>

<p>一开始，在办公环境下，我在内网环境部署的 Galaxy 和 <a href="https://usegalaxy.org/">https://usegalaxy.org/</a> 中分别对 xlsx 格式的文件进行上传测试，发现：</p>

<ul>
<li>在 Chrome 中两个 Galaxy 都能正常上传文件，没有任何错误。</li>

<li><p>只有在 Firefox 中两个 Galaxy 才会出现如上截图的相同 Warning。于是，下意识的，我开始怀疑，是不是 Firefox 会针对 Excel 的文件进行了特殊处理？还是 Galaxy 的 xlsx 文件识别存在 bug？针对前一个问题，我一开始并不知道如何去验证，但对于后一个问题，我开始了另外的尝试。</p></li>

<li><p><strong>start_cgi_http_server.sh</strong></p></li>
</ul>

<pre><code class="language-bash">#!/bin/bash

mkdir ./cgi-bin/
cp upload.cgi ./cgi-bin/
chmod +x ./cgi-bin/upload.cgi
mkdir ./upload/
python -m http.server --cgi 8080
</code></pre>

<ul>
<li><strong>upload.cgi</strong></li>
</ul>

<p>**</p>

<pre><code class="language-python">#!/usr/bin/python
# -*- coding: utf-8 -*-

import cgi, cgitb, os, sys

UPLOAD_DIR = './upload'

def save_uploaded_file():
    print 'Content-Type: text/html; charset=UTF-8'
    print
    print '''
&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;Upload File&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
'''

    form = cgi.FieldStorage()
    if not form.has_key('file'):
        print '&lt;h1&gt;Not found parameter: file&lt;/h1&gt;'
        return

    form_file = form['file']
    if not form_file.file:
        print '&lt;h1&gt;Not found parameter: file&lt;/h1&gt;'
        return

    if not form_file.filename:
        print '&lt;h1&gt;Not found parameter: file&lt;/h1&gt;'
        return

    uploaded_file_path = os.path.join(UPLOAD_DIR, os.path.basename(form_file.filename))
    with file(uploaded_file_path, 'wb') as fout:
        while True:
            chunk = form_file.file.read(100000)
            if not chunk:
                break
            fout.write (chunk)
    print '&lt;h1&gt;Completed file upload&lt;/h1&gt;'

    print '''
&lt;hr&gt;
&lt;a href=&quot;../upload.html&quot;&gt;Back to upload page&lt;/a&gt;
&lt;/body&gt;
&lt;/html&gt;
'''

cgitb.enable()
save_uploaded_file()
</code></pre>

<ul>
<li><strong>upload.html</strong></li>
</ul>

<pre><code class="language-python">&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;Upload File&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;Upload File&lt;/h1&gt;
  &lt;form action=&quot;cgi-bin/upload.cgi&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt;
    File: &lt;input name=&quot;file&quot; type=&quot;file&quot;&gt;
    &lt;input name=&quot;submit&quot; type=&quot;submit&quot;&gt;
  &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>通过这三个程序，就可以在 Linux 下启动一个简单文件上传小网站。</p>

<p><a href="https://www.yuque.com/shenweiyan/bio-cloud/galaxy-xlsx-issues?_lake_card=%7B%22status%22%3A%22done%22%2C%22name%22%3A%222020-01-02+15-54-41.mp4%22%2C%22size%22%3A15245946%2C%22percent%22%3A0%2C%22id%22%3A%22nXnfR%22%2C%22videoId%22%3A%225f91d7d6cc7e440683ca0df6e80732fe%22%2C%22aliyunVideoSrc%22%3Anull%2C%22taobaoVideoId%22%3A%22249884374144%22%2C%22uploaderId%22%3A126032%2C%22authKey%22%3A%22YXBwX2tleT04MDAwMDAwMTImYXV0aF9pbmZvPXsidGltZXN0YW1wRW5jcnlwdGVkIjoiMTczODE3N2U1YzY2YTQyYzU5OGIwNGRlNjNjN2Y4YWUifSZkdXJhdGlvbj0mdGltZXN0YW1wPTE1NzgwMzMwNzA%3D%22%2C%22docUrl%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fshenweiyan%2Fbio-cloud%2Fgalaxy-xlsx-issues%22%2C%22coverUrl%22%3A%22https%3A%2F%2Fqiniu.bioinit.com%2Fyuque%2F0%2F2020%2Fjpeg%2F126032%2F1577957172406-365eda9f-c949-4b38-aca1-c8004374716c.jpeg%22%2C%22card%22%3A%22video%22%7D#nXnfR"><img src="https://qiniu.bioinit.com/yuque/0/2020/jpeg/126032/1577957172406-365eda9f-c949-4b38-aca1-c8004374716c.jpeg?x-oss-process=image/resize,h_450" alt="2020-01-02 15-54-41.mp4 (14.54MB)" /></a></p>

<h2 id="xlsx-文件识别">xlsx 文件识别</h2>

<p>通过 python cgi 上传完文件后，在使用 python 模块进行处理的时，发现通过 Firefox 上传的文件开始出现问题了：</p>

<pre><code class="language-python">In [1]: import pandas as pd
In [2]: pd.read_excel(&quot;upload/upload.xlsx&quot;)
---------------------------------------------------------------------------
XLRDError                                 Traceback (most recent call last)
&lt;ipython-input-8-9e85b7330a4e&gt; in &lt;module&gt;
----&gt; 1 pd.read_excel(&quot;upload/upload.xlsx&quot;)

......

XLRDError: Unsupported format, or corrupt file: Expected BOF record; found b'b\x14#e\xa9\x01W\x00'
</code></pre>

<p>于是，开始回去看 Galaxy 的源码，想要搞明白 Galaxy 对于 xlsx 文件上传到底是怎么进行识别的，终于在 <code>packages/data/galaxy/datatypes/binary.py</code> 中发现 Galaxy 正是使用了 python 的 <code>zipfile</code> 模块 ：</p>

<p><a data-fancybox="gallery" href="https://qiniu.bioinit.com/yuque/0/2020/png/126032/1577953605841-778111ab-4e64-416d-81d8-5bae0a0163dd.png#align=left&amp;display=inline&amp;height=657&amp;name=image.png&amp;originHeight=657&amp;originWidth=734&amp;size=70032&amp;status=done&amp;style=none&amp;width=734"><img src="https://qiniu.bioinit.com/yuque/0/2020/png/126032/1577953605841-778111ab-4e64-416d-81d8-5bae0a0163dd.png#align=left&amp;display=inline&amp;height=657&amp;name=image.png&amp;originHeight=657&amp;originWidth=734&amp;size=70032&amp;status=done&amp;style=none&amp;width=734" alt=""></a></p>

<p>于是，我也开始使用 <code>zipfile</code> 来对先前 python cgi 上传的文件进行测试：</p>

<pre><code class="language-python">In [9]: import zipfile

In [10]: zipfile.ZipFile(&quot;upload/upload.xlsx&quot;)
---------------------------------------------------------------------------
BadZipFile                                Traceback (most recent call last)
&lt;ipython-input-10-3793f2363956&gt; in &lt;module&gt;
----&gt; 1 zipfile.ZipFile(&quot;upload/upload.xlsx&quot;)

......

BadZipFile: File is not a zip file
</code></pre>

<p>同样的操作，我在 Chrome 重复了一遍，但是却神奇的发现，不管是 <code>panda</code> 还是 <code>zipfile</code> 模块，竟然一切都表现正常！ 似乎，Firefox 的确有点不正常。## 真正原因</p>

<p>针对这个问题，我最开始向 Galaxy Project 团队咨询过，但一直没有从根本解决掉这个问题，他们建议考虑非 xlsx 格式数据的工具开发。</p>

<p><a data-fancybox="gallery" href="https://qiniu.bioinit.com/yuque/0/2019/jpeg/126032/1562808631934-a67f49e6-a306-4e12-acdf-e8cb3d176bd2.jpeg#align=left&amp;display=inline&amp;height=1395&amp;originHeight=1395&amp;originWidth=1080&amp;status=done&amp;style=none&amp;width=1080"><img src="https://qiniu.bioinit.com/yuque/0/2019/jpeg/126032/1562808631934-a67f49e6-a306-4e12-acdf-e8cb3d176bd2.jpeg#align=left&amp;display=inline&amp;height=1395&amp;originHeight=1395&amp;originWidth=1080&amp;status=done&amp;style=none&amp;width=1080" alt=""></a></p>

<p>直到前几天，突发奇想在 Firefox 社区中重新提起这个事情，一个热心网友的回复才让我意识到了问题的所在，也就是哈希——文件完整性校验。</p>

<p><a data-fancybox="gallery" href="https://qiniu.bioinit.com/yuque/0/2020/png/126032/1577955329338-cb12b774-b017-4eae-9376-95aff28914af.png#align=left&amp;display=inline&amp;height=489&amp;name=image.png&amp;originHeight=489&amp;originWidth=690&amp;size=41835&amp;status=done&amp;style=none&amp;width=690"><img src="https://qiniu.bioinit.com/yuque/0/2020/png/126032/1577955329338-cb12b774-b017-4eae-9376-95aff28914af.png#align=left&amp;display=inline&amp;height=489&amp;name=image.png&amp;originHeight=489&amp;originWidth=690&amp;size=41835&amp;status=done&amp;style=none&amp;width=690" alt=""></a></p>

<p>我把文件上传前的 MD5 和文件上传后的 MD5 重新进行了计算比较，这才发现：</p>

<ul>
<li>使用 Firefox 上传前后文件的 MD5 是一致，Python 却不能识别为有效的 zip 文件；</li>
<li>使用 Chrome 上传的文件前后 MD5 是不一致的，Python 却能正常识别为有效的 zip 文件。</li>
</ul>

<p>很明显，我的原始 xlsx 文件是有问题的！！吐血中！！！但是在办公环境中，这个原始的 xlsx 文件不管是 Office 2016 还是 WPS 都能正常打开，正常编辑保存。唯一不同的是文件中多了一个锁的标志。</p>

<p><img src="https://qiniu.bioinit.com/yuque/0/2020/png/126032/1577955786229-5e2c4184-4712-417f-8c9a-ba695b81d5d5.png#align=left&amp;display=inline&amp;height=108&amp;name=image.png&amp;originHeight=108&amp;originWidth=632&amp;size=10347&amp;status=done&amp;style=none&amp;width=632" alt="" />
其实，这就是企业企业办公文档 Office Excel 软件加密的一种效果。</p>

<ol>
<li>安装加密软件：安装加密服务端和管理端，客户端安装在被加密的电脑中;</li>
<li>设置加密策略：打开管理端，选择文件加密—加密策略，勾选需要加密的 office Excel，然后保存策略，如下图;重启被加密员工电脑。</li>
</ol>

<p><a data-fancybox="gallery" href="https://qiniu.bioinit.com/yuque/0/2020/jpeg/126032/1577956204996-bf0c004b-0552-40e2-b5b9-5ca3184a0a3e.jpeg#align=left&amp;display=inline&amp;height=654&amp;originHeight=654&amp;originWidth=967&amp;size=0&amp;status=done&amp;style=none&amp;width=967"><img src="https://qiniu.bioinit.com/yuque/0/2020/jpeg/126032/1577956204996-bf0c004b-0552-40e2-b5b9-5ca3184a0a3e.jpeg#align=left&amp;display=inline&amp;height=654&amp;originHeight=654&amp;originWidth=967&amp;size=0&amp;status=done&amp;style=none&amp;width=967" alt=""></a></p>

<p><strong>测试加密效果：</strong>被加密电脑重启后，打开 word 文档，新建文档并编辑保存，保存后的文件会显示“加锁”标志，如下图示，显示已成功加密。 </p>

<p><a data-fancybox="gallery" href="https://qiniu.bioinit.com/yuque/0/2020/jpeg/126032/1577956244695-d279b5a9-242e-4569-a62f-d6874457b079.jpeg#align=left&amp;display=inline&amp;height=91&amp;originHeight=91&amp;originWidth=91&amp;size=0&amp;status=done&amp;style=none&amp;width=91"><img src="https://qiniu.bioinit.com/yuque/0/2020/jpeg/126032/1577956244695-d279b5a9-242e-4569-a62f-d6874457b079.jpeg#align=left&amp;display=inline&amp;height=91&amp;originHeight=91&amp;originWidth=91&amp;size=0&amp;status=done&amp;style=none&amp;width=91" alt=""></a></p>

<p><strong>实现效果</strong>：员工编辑后的文档自动加密，加密后的文档未经许可，私自通过 QQ，电子邮件，U盘等任何方式传输到公司以外，都将无法打开使用；不改变编辑操作习惯，在企业内部相互流通编辑，不受影响。彻底从源头保障数据的安全性。此外还可实现如需外发文件，可通过申请解密流程授权解密后方可外发；同时还可对其他软件进行加密，比如办公软件，设计软件，工程软件，编程软件，研发软件等。</p>

<p>最后，把未加密的 xlsx 文件进行重新测试，一切问题迎刃而解。## 总结一下</p>

<p>这是一个企业文档加密引发的填坑记录，从问题的发现，问题的思考，到解决的思路值得探讨记录一下。</p>

<ul>
<li>MD5，MD5，MD5，重要的事情要说三遍！！！</li>
<li>了解 Galaxy 文件上传和识别的一些思路，对特定格式文件的定制化处理有更深理解。</li>
<li>接触了 Python CGI 的一些简单应用，总体而言，挺好玩的。</li>
<li>多多交流，学会搜索，善用资源，事半功倍。</li>
</ul>

<p>Chrome 为什么能绕开部分企业文档加密的枷锁，还原文件，这是一个有待后面学习的问题，mark 一下，同时期待老师们指点迷津。## 参考资料</p>

<ol>
<li>易控王，<a href="http://www.ekongsoft.com/a/xinwenzhongxin/wenjianjiami/41.html">如何加密excel表格？企业excel表格加密方法</a>，易控王新闻中心</li>
<li>istevenshen，<a href="https://help.galaxyproject.org/t/xlsx-upload-failed-in-usegalaxy-org/1346">xlsx upload failed in usegalaxy.org</a>，Galaxy Help</li>
<li>史提芬先生，<a href="https://support.mozilla.org/zh-CN/kb/%E8%8E%B7%E5%BE%97%E7%A4%BE%E5%8C%BA%E6%94%AF%E6%8C%81/discuss/8254?utm_campaign=kbforums-post&amp;utm_medium=email&amp;utm_source=notification#post-18529">火狐上传 Excel bug</a>，Mozilla 技术支持</li>
</ol>


  <footer>
  
<nav class="post-nav">
  <span class="nav-prev">
      
      <a href="../../../topic/tech/2019-12-30-opodb3/">从 Jupyter Notebook 升级到 JupyterLab</a>
      <br/>&larr;&nbsp;
      
  </span>
  <span class="nav-next">
      
      <a href="../../../topic/tech/2020-01-03-galaxy-xlsx-upload-issues/">Galaxy 生信平台（三）：xlsx 上传与识别</a>
      <br/>&nbsp;&rarr;
      
  </span>
</nav>
<script type="text/javascript">
document.addEventListener('keyup', function(e) {
  if (e.target.nodeName.toUpperCase() != 'BODY') return;
  var url = false;
  if (e.which == 37) {  
    
    url = '\/topic\/tech\/2019-12-30-opodb3\/';
    
  } else if (e.which == 39) {  
    
    url = '\/topic\/tech\/2020-01-03-galaxy-xlsx-upload-issues\/';
    
  }
  if (url) window.location = url;
});
</script>



<section class="comments">
<script src="https://utteranc.es/client.js"
        repo="shenweiyan/issues"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</section>




<script async src="../../../js/fix-toc.js"></script>

<script async src="../../../js/center-img.js"></script>

<script async src="../../../js/right-quote.js"></script>

<script async src="../../../js/no-highlight.js"></script>

<script async src="../../../js/fix-footnote.js"></script>

<script async src="../../../js/math-code.js"></script>

<script async src="../../../js/external-link.js"></script>

<script async src="../../../js/alt-title.js"></script>

<script async src="../../../js/header-link.js"></script>

<script async src="../../../js/dom-scripts.js"></script>


<script async src="//cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>



  
  
  
  

  <script type="text/javascript" src="//rf.revolvermaps.com/0/0/6.js?i=5m6pzaeh5ar&amp;m=0&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=0&amp;bv=0" async="async"></script>
  </footer>
  </article>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
  </body>
</html>

